---
title: "Stan Practice"
author: "Ali Campbell"
date: "1/13/2021"
output: html_document
---

```{r setup, include=FALSE}
library(rstanarm)
library(brms)  # for models
library(tidyverse)
library(rstan)
library(StanHeaders)
library(shinystan)
library(bayesplot)
library(devtools)
library(tidyr)
library(lattice)
library(lme4)
library(dplyr)
library(tidyverse)
library(nnet)
library(fixest)
library(mlogit)
library(dfidx)
library(effects)
library(bbmle)
library(magrittr)
library(Gmisc)
library(RColorBrewer)
library(ggeffects)
library(heplots)
library("posterior")
#library(sjPlot)
knitr::opts_chunk$set(echo = TRUE)
options(mc.cores = parallel::detectCores())
setwd("/Users/alicampbell/Box Sync/Grad/Cactus/Shared Code/ant_cactus_demography/Stan")
```

#### Data

```{r}
data <- cactus[ ,c("Plot","Year_t","Survival_t1","ant_t","ant_t1","volume_t","volume_t1")]
data <- na.omit(data)
data$ant <- as.integer(data$ant_t)
## add columns for each ant classification so they can be binary
data$crem <- 0 ##2
data$liom <- 0 ##3
data$other <- 0 ##1
data$vacant <- 0 ##4
for(i in 1:nrow(data)){
  if(data$ant[i] == 1){data$other[i] <- 1}
  if(data$ant[i] == 2){data$crem[i] <- 1}
  if(data$ant[i] == 3){data$liom[i] <- 1}
  if(data$ant[i] == 4){data$vacant[i] <- 1}
}
```

## Basic Models (No Ant Effects)
```{r Growth Model}
## Now rename variables and index
x <- log(data$volume_t)
z <- as.numeric(data$ant_t)
y <- log(data$volume_t1)
N <- length(data$volume_t)
K <- length(data$ant_t)
## Rerun linear model with that new data
#mod1 <- lm(y~x, data = data)
#summary(grow_model)
#summary(mod1)
## Now we can extract some important statistics
lm_alpha <- summary(grow_model)$coeff[1]  # the intercept
lm_beta <- summary(grow_model)$coeff[2]  # the slope
lm_sigma <- sigma(grow_model)  # the residual error
## Make it a dataframe
stan_data <- list(N = N, x = x, y = y, z = z, K = K)
## Write the model in stan
#note that we are using flat priors here which are non restrictive
write("// Stan model for simple growth regression

data {
 int < lower = 1 > N; // Sample size
 vector[N] x; // Predictor
 vector[N] y; // Outcome
}

parameters {
 real alpha; // Intercept
 real beta; // Slope (regression coefficients)
 real < lower = 0 > sigma; // Error SD
}

model {
// Priors
alpha ~ normal(0,100);
beta ~ normal(0,100); 
//sigma ~ exponential(0,0);
 y ~ normal(alpha + x * beta , sigma); // The Model
}

generated quantities {
} // The posterior predictive distribution",

"grow_lm1.stan")
## Check that you wrote a file
#stanc("grow_lm1.stan")
## Save the file path
stanny <- "grow_lm1.stan"
## Now we fit the model
fit <- stan(file = stanny, data = stan_data, warmup = 500, iter = 1000, chains = 4, cores = 2, thin = 1)
fit
#class(fit)
posterior <- as.data.frame(fit)
print(colnames(posterior))

par(mfrow = c(1,3))
plot(density(posterior$alpha), main = "Alpha")
abline(v = lm_alpha, col = 4, lty = 2)
plot(density(posterior$beta), main = "Beta")
abline(v = lm_beta, col = 4, lty = 2)
plot(density(posterior$sigma), main = "Sigma")
abline(v = lm_sigma, col = 4, lty = 2)
```

```{r Total Flowers}
x <- log(data$volume_t)
y <- data$TotFlowerbuds_t
N <- length(data$volume_t)
## Rerun linear model with that new data
#mod1 <- lm(y~x, data = data)
summary(flower_model)
#summary(mod1)
## Now we can extract some important statistics
lm_lambda = mean(data$TotFlowerbuds_t)
## Make it a dataframe
stan_data <- list(N = N, x = x, y = y)
## Write the model in stan
#note that we are using flat priors here which are non restrictive
write("// Stan model for simple total flowers regression

data {
 int N;
 real x[N];
 int y[N];
}
parameters {
 real<lower = 0> lambda;
}
model {
// Priors
 lambda ~ cauchy(0, 1);
 //lambda ~ gamma(0, 0);
 // Model
 y ~ poisson(lambda);
}
",

"flower_lm1.stan")
## Check that you wrote a file
stanc("flower_lm1.stan")
## Save the file path
stanny <- "flower_lm1.stan"
## Now we fit the model
fit <- stan(file = stanny, data = stan_data, warmup = 500, iter = 1000, chains = 4, cores = 2, thin = 1)
fit

posterior <- as.data.frame(fit)
print(colnames(posterior))

plot(density(posterior$lambda), main = "Lambda")
abline(v = lm_lambda, col = 4, lty = 2)
```

```{r Survival}
x <- log(data$volume_t)
y <- data$Survival_t1
N <- length(data$volume_t)
#import things from the r regression models for comparison
lm_alpha <- summary(surv_model)$coeff[1]  # the intercept
lm_beta <- summary(surv_model)$coeff[2]  # the slope
summary(surv_model)
## Make it a dataframe
stan_data <- list(N = N, x = x, y = y)
## Write the model in stan
#note that we are using flat priors here which are non restrictive
write("// Stan model for simple survival regression

data {
  int<lower=0> N;
  vector[N] x;
  int<lower=0,upper=1> y[N];
}
parameters {
  real alpha;
  real beta;
}
model {
 // Priors
 alpha ~ normal(0,100);
 beta ~ normal(0,100); 
 // Model
 y ~ bernoulli_logit(alpha + beta * x);
}
",

"surv_lm1.stan")
## Check that you wrote a file
stanc("surv_lm1.stan")
## Save the file path
stanny <- "surv_lm1.stan"
## Now we fit the model
fit <- stan(file = stanny, data = stan_data, warmup = 500, iter = 1000, chains = 4, cores = 2, thin = 1)
fit

posterior <- as.data.frame(fit)
print(colnames(posterior))


par(mfrow = c(1,2))

plot(density(posterior$alpha), main = "Alpha")
abline(v = lm_alpha, col = 4, lty = 2)

plot(density(posterior$beta), main = "Beta")
abline(v = lm_beta, col = 4, lty = 2)
```

#### Include ants
######Growth
```{r Growth Model}
## Now rename variables and index
vol <- log(data$volume_t)
ant <- as.numeric(data$ant_t)
y <- log(data$volume_t1)
N <- length(data$volume_t)
K <- length(data$ant_t)
## Make it a dataframe
stan_data <- list(N = N, vol = vol, y = y, ant = ant, K = K)
lm_alpha <- summary(grow_model_ant_interact)$coeff[1]  # the intercept
lm_beta <- summary(grow_model_ant_interact)$coeff[2]  # the slope
lm_sigma <- sigma(grow_model_ant_interact)  # the residual error

write("// Stan model for ant growth regression

data {
 int < lower = 1 > N; // Sample size
 int < lower = 1 > K; // Number of Predictors (Ant Species)
 real < lower = 0 > vol[N]; // volume
 int < lower = 0 > ant[K]; // ants
 real < lower = 0 > y[N]; // outcome vector
}

parameters {
 real alpha; // Intercept
 vector[K] beta; // coefficients for predictors
 real < lower = 0 > sigma; // Error SD
}

transformed parameters{
real mu[N];
for(i in 1:N){
mu[i] = beta[1] + beta[2]*vol[i] + beta[3]*ant[i]; 
             }
}

model {
// Priors
alpha ~ normal(0,100);
beta ~ normal(0,100); 
//sigma ~ exponential(0,0);
 y ~  normal(mu, sigma);   // The Model
}

generated quantities {
} // The posterior predictive distribution",

"grow_ant_lm1.stan")
## Check that you wrote a file
stanc("grow_ant_lm1.stan")
## Save the file path
stanny <- "grow_ant_lm1.stan"
## Now we fit the model
fit <- stan(file = stanny, data = stan_data, warmup = 500, iter = 1000 , chains = 4, cores = 2, thin = 1)
fit


posterior <- as.data.frame(fit)
print(colnames(posterior))


par(mfrow = c(1,2))

plot(density(posterior$alpha), main = "Alpha")
abline(v = lm_alpha, col = 4, lty = 2)

#plot(density(posterior$beta[i]), main = "Beta")
#abline(v = lm_beta, col = 4, lty = 2)

plot(density(posterior$sigma), main = "Sigma")
abline(v = lm_sigma, col = 4, lty = 2)
```


```{r grow attempt 1}
vol = data$volume_t
y = data$volume_t1
crem = data$crem
liom = data$liom
vacant = data$vacant
other = data$other
N = nrow(data)
stan_data <- list(N = N, ## number of observations
                  vol = vol, ## predictors volume
                  y = y, ## response volume next year
                  crem = crem, liom = liom, vacant = vacant, other = other) ## predictors ants

write("
      data{
      int <lower = 1> N; // Number of observations
      vector[N] vol; // volume predictor
      int <lower = 0, upper = 1> crem[N]; // crem predictor
      int <lower = 0, upper = 1> liom[N]; // liom predictor
      int <lower = 0, upper = 1> other[N]; // other predictor
      int <lower = 0, upper = 1> vacant[N]; // vacant predictor
      vector[N] y; // outcome
      }
      parameters{
      real alpha; // intercept 
      real b_crem; // crem slope
      real b_liom; // liom slope
      real b_other; // other slope
      real b_vacant; // vacant slope
      real <lower = 0> sigma; // standard deviation
      }
      model{
      // Priors
      alpha ~ normal(0,100);
      beta ~ normal(0,100);
      // Likelihood
      y ~ normal(alpha + (b_crem*crem[N] + b_liom*liom[N] + b_other*other[N] + b_vacant*vacant[N])*vol ,sigma);
      }
      ",
      "tester1.stan")

stanc("tester1.stan")

fit <- stan(file = "tester1.stan", data = stan_data, warmup = 500, iter = 1000, chains = 1, cores = 2, thin = 1)
fit

posterior <- as.data.frame(fit)
print(colnames(posterior))
par(mfrow = c(2,3))
plot(density(posterior$alpha), main = "Alpha")
abline(v = lm_alpha, col = 4, lty = 2)
plot(density(posterior$b_other), main = "Beta Other")
abline(v = lm_beta, col = 4, lty = 2)
plot(density(posterior$b_vacant), main = "Beta Vacant")
abline(v = lm_beta, col = 4, lty = 2)
plot(density(posterior$b_crem), main = "Beta Crem")
abline(v = lm_beta, col = 4, lty = 2)
plot(density(posterior$b_liom), main = "Beta Liom")
abline(v = lm_beta, col = 4, lty = 2)
plot(density(posterior$sigma), main = "Sigma")
abline(v = lm_sigma, col = 4, lty = 2)
```

```{r grow attempt 2&3}
vol <- log(data$volume_t)
ant <- as.numeric(data$ant_t)
y <- log(data$Survival_t1)
N <- length(data$volume_t)
K <- length(data$ant_t)
## Make it a dataframe
stan_data <- list(N = N, vol = vol, y = y, ant = ant, K = K)
## Write the model in stan
lm_alpha <- summary(surv_model_ant)$coeff[1]  # the intercept
lm_beta <- summary(surv_model_ant)$coeff[2]  # the slope
lm_sigma <- sigma(surv_model_ant_interact)  # the residual error
write("// Stan model for simple linear regression

data {
 int < lower = 1 > N; // Sample size
 int < lower = 1 > K; // Number of Predictors (Ant Species)
 real < lower = 0 > vol[N]; // volume
 int < lower = 0 > ant[K]; // ants
 int <lower=0,upper=1> y[N]; // outcome vector
}

parameters {
  real alpha;
  vector[K] beta; // coefficients for predictors
}

transformed parameters{
 real mu[N];
 for(i in 1:N){
 mu[i] = beta[1] + beta[2]*vol[i] + beta[3]*ant[i]; 
 }
}

model {
//Priors
 alpha ~ normal(0,100);
 beta ~ normal(0,100);
 //Model
 y ~ bernoulli_logit(mu);
}
",

"surv_ant_lm1.stan")
## Check that you wrote a file
stanc("surv_ant_lm1.stan")
## Save the file path
stanny <- "surv_ant_lm1.stan"
## Now we fit the model
fit <- stan(file = stanny, data = stan_data, warmup = 5000, iter = 10000, chains = 1, cores = 2, thin = 1)
fit

posterior <- as.data.frame(fit)
print(colnames(posterior))


plot(density(posterior$alpha), main = "Alpha")
abline(v = lm_alpha, col = 4, lty = 2)
```

######Survival

```{r survival}
vol <- log(data$volume_t)
ant <- as.numeric(data$ant_t)
y <- log(data$Survival_t1)
N <- length(data$volume_t)
K <- length(data$ant_t)
## Make it a dataframe
stan_data <- list(N = N, vol = vol, y = y, ant = ant, K = K)
## Write the model in stan
lm_alpha <- summary(surv_model_ant)$coeff[1]  # the intercept
lm_beta <- summary(surv_model_ant)$coeff[2]  # the slope
lm_sigma <- sigma(surv_model_ant_interact)  # the residual error
write("// Stan model for simple ant survival regression

data {
 int < lower = 1 > N; // Sample size
 int < lower = 1 > K; // Number of Predictors (Ant Species)
 real < lower = 0 > vol[N]; // volume
 int < lower = 0 > ant[K]; // ants
 int <lower=0,upper=1> y[N]; // outcome vector
}

parameters {
  real alpha;
  vector[K] beta; // coefficients for predictors
}

transformed parameters{
 real mu[N];
 for(i in 1:N){
 mu[i] = beta[1] + beta[2]*vol[i] + beta[3]*ant[i]; 
 }
}

model {
//Priors
 alpha ~ normal(0,100);
 beta ~ normal(0,100);
 //Model
 y ~ bernoulli_logit(mu);
}
",

"surv_ant_lm1.stan")
## Check that you wrote a file
stanc("surv_ant_lm1.stan")
## Save the file path
stanny <- "surv_ant_lm1.stan"
## Now we fit the model
fit <- stan(file = stanny, data = stan_data, warmup = 5000, iter = 10000, chains = 1, cores = 2, thin = 1)
fit

posterior <- as.data.frame(fit)
print(colnames(posterior))

plot(density(posterior$alpha), main = "Alpha")
abline(v = lm_alpha, col = 4, lty = 2)
```

```{r surv attempt 1}
vol = data$volume_t
y = as.integer(data$Survival_t1)
crem = data$crem
liom = data$liom
vacant = data$vacant
other = data$other
N = nrow(data)
stan_data <- list(N = N, ## number of observations
                  vol = vol, ## predictors volume
                  y = y, ## response volume next year
                  crem = crem, liom = liom, vacant = vacant, other = other) ## predictors ants

write("
      data{
      int <lower = 1> N; // Number of observations
      vector[N] vol; // volume predictor
      int <lower = 0, upper = 1> crem[N]; // crem predictor
      int <lower = 0, upper = 1> liom[N]; // liom predictor
      int <lower = 0, upper = 1> other[N]; // other predictor
      int <lower = 0, upper = 1> vacant[N]; // vacant predictor
      int <lower = 0, upper = 1> y[N]; // outcome
      }
      parameters{
      real alpha; // intercept 
      real b_crem; // crem slope
      real b_liom; // liom slope
      real b_other; // other slope
      real b_vacant; // vacant slope
      real <lower = 0> sigma; // standard deviation
      }
      model{
      // Priors
      alpha ~ normal(0,100);
      // Likelihood
      y ~ bernoulli_logit(alpha + (b_crem*crem[N] + b_liom*liom[N] + b_other*other[N] + b_vacant*vacant[N])*vol);
      }
      ",
      "tester1.stan")

stanc("tester1.stan")

fit <- stan(file = "tester1.stan", data = stan_data, warmup = 500, iter = 1000, chains = 1, cores = 2, thin = 1)
fit
```


