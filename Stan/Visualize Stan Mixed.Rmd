---
title: "Visualize Stan Mixed Models"
author: "Ali Campbell"
date: "2/25/2021"
output: html_document
---

```{r setup, include=FALSE}
library(rstanarm)
#library(rstansim)
library(brms)  # for models
library(tidyverse)
library(rstan)
library(StanHeaders)
library(shinystan)
#library(bayesplot)
library(devtools)
library(tidyr)
library(lattice)
library(lme4)
library(dplyr)
library(tidyverse)
library(nnet)
library(fixest)
library(mlogit)
library(dfidx)
library(effects)
library(bbmle)
library(magrittr)
library(Gmisc)
library(RColorBrewer)
library(ggeffects)
library(heplots)
library("posterior")
#library(sjPlot)
knitr::opts_chunk$set(echo = TRUE)
options(mc.cores = parallel::detectCores())
setwd("/Users/alicampbell/Box Sync/Grad/Cactus/Shared Code/ant_cactus_demography/Stan")
```

#### Data

```{r}
cactus$ant_t1_relevel <- relevel(cactus$ant_t1,ref = "vacant")
data <- cactus[ ,c("Plot","Year_t","Survival_t1","ant_t","ant_t1","volume_t","volume_t1","repro_state_t1", "ant_t1_relevel")]
data <- na.omit(data)
data$ant <- as.integer(data$ant_t)
data$ant1 <- as.integer(data$ant_t1_relevel)
## add columns for each ant classification so they can be binary
data$crem <- 0 ##2
data$liom <- 0 ##3
data$other <- 0 ##1
data$vacant <- 0 ##4
for(i in 1:nrow(data)){
  if(data$ant[i] == 1){data$other[i] <- 1}
  if(data$ant[i] == 2){data$crem[i] <- 1}
  if(data$ant[i] == 3){data$liom[i] <- 1}
  if(data$ant[i] == 4){data$vacant[i] <- 1}
}
data$Year_t <- as.factor(data$Year_t)
data$year <- as.integer(data$Year_t)
data$Plot <- as.factor(data$Plot)
data$plot <- as.integer(data$Plot)


## Flower Data Set
flower <- cactus[ , c("TotFlowerbuds_t","ABFlowerbuds_t","Goodbuds_t","ant_t", "repro_state_t1","volume_t","volume_t1","Year_t","Plot")]
flower <- na.omit(flower)
flower$ant <- as.integer(flower$ant_t)
flower$Year_t <- as.factor(flower$Year_t)
flower$year <- as.integer(flower$Year_t)
flower$Plot <- as.factor(flower$Plot)
flower$plot <- as.integer(flower$Plot)
```

#### Growth
```{r Growth Mixed Ant Model}
vol = log(data$volume_t)
y = log(data$volume_t1)
N = nrow(data)
N_ant = 4
ant = data$ant
N_Year <- max(data$year)
N_Plot <- max(data$plot)
plot <- data$plot
year <- data$year
stan_data <- list(N = N, ## number of observations
                  vol = vol, ## predictors volume
                  y = y, ## response volume next year
                  ant = ant,## predictors ants
                  N_ant = N_ant, ## number of ant states
                  N_Year = N_Year, ## number of years
                  N_Plot = N_Plot, ## number of plots
                  plot = plot, ## predictor plots
                  year = year ## predictor years
) 
## Write the model in stan
#note that we are using flat priors here which are non restrictive
write("// Stan model for simple growth regression
data {
  int <lower = 1> N; // number of observations
  int <lower = 1> N_ant; // number of ant states
  int <lower = 1, upper = N_ant> ant[N]; // the list of ant species 
  vector[N] vol;	//size_t
  vector[N] y; // size_t1
  int<lower=1> N_Year; //number of plots
  int<lower=1> N_Plot; //number of years
  int<lower=1, upper=N_Plot> plot[N]; // plot
  int<lower=1, upper=N_Year> year[N]; // year
}
transformed data {
  real<lower = 0> mean_y = mean(to_vector(y));
  real<lower = 0> sd_y = sd(to_vector(y));
}
parameters {
  vector[N_ant] beta0; //intercept, unique to ant sp
  vector[N_ant] beta1; //slope, unique to ant sp
  vector[N_Plot] u; //subject intercepts
  vector[N_Year] w; //item intercepts
  real < lower = 0 > sigma; // Error SD
  real < lower = 0 > sigma_u; // plot SD
  real < lower = 0 > sigma_w; // year SD
}
transformed parameters{
  vector[N] mu; //linear predictor for the mean
  for(i in 1:N){
    mu[i] = beta0[ant[i]] + beta1[ant[i]] * vol[i] + u[plot[i]] + w[year[i]];
  }
}
model {
  u ~ normal(0, sigma_u); // plot random effects
  w ~ normal(0, sigma_w); // year random effects
  beta0 ~ normal(0,100); // intercept distribution
  beta1 ~ normal(0,100); // slope distribution
  for(i in 1:N){
    y[i] ~ normal(mu[i], sigma);
  }
}
generated quantities{
  real  y_rep[N] = normal_rng(mu, sigma);
  real  mean_y_rep = mean(to_vector(y_rep));
  real  sd_y_rep = sd(to_vector(y_rep));
}
",
"grow_ant_mix_lm1.stan")
## Check that you wrote a file
#stanc("grow_ant_mix_lm1.stan")
## Save the file path
stanny <- "grow_ant_mix_lm1.stan"
## Now we fit the model
fit_grow_mix_ant <- stan(file = stanny, data = stan_data, warmup = 5, iter = 10, chains = 1, cores = 2, thin = 1)
#fit_grow_mix_ant
#class(fit)
posterior_grow_mix_ant <- as.data.frame(fit_grow_mix_ant)
```

```{r Growth Visualizations}
lm_alpha_other <- summary(grow_model_ant_interact)$coeff[1]  # the intercept
lm_alpha_crem <- summary(grow_model_ant_interact)$coeff[3]
lm_alpha_liom <- summary(grow_model_ant_interact)$coeff[4]
lm_alpha_vacant <- summary(grow_model_ant_interact)$coeff[5]
lm_beta_other <- summary(grow_model_ant_interact)$coeff[2]  # the slope
lm_beta_crem <- summary(grow_model_ant_interact)$coeff[6]
lm_beta_liom <- summary(grow_model_ant_interact)$coeff[7]
lm_beta_vacant <- summary(grow_model_ant_interact)$coeff[8]
lm_sigma <- sigma(grow_model_ant_interact)  # the residual error

par(mfrow = c(1,2))
#Plot Intercepts
plot(density(posterior_grow_mix_ant$`beta0[1]`), main = "Growth Intercept Distributions", col = "black", lwd = 2, xlim = c(-4,2), ylim =  c(0,10))
abline(v = lm_alpha_other, col = "black", lty = 2)
lines(density(posterior_grow_mix_ant$`beta0[2]`),  col = "red")
abline(v = lm_alpha_crem, col = "red", lty = 2)
lines(density(posterior_grow_mix_ant$`beta0[3]`),col = "blue", lwd = 2)
abline(v = lm_alpha_liom, col = "blue", lty = 2)
lines(density(posterior_grow_mix_ant$`beta0[4]`), col = "pink", lwd = 2)
abline(v = lm_alpha_vacant, col = "pink", lty = 2)
legend("topleft", legend = c("other","Crem.", "Liom.","Vac"), col = c("black","red","blue","pink"), lty = 1)
#Plot Slopes
plot(density(posterior_grow_mix_ant$`beta1[1]`), main = "Growth Slope Distributions", col = "black", lwd = 2, xlim = c(-4,5), ylim = c(0,1.4))
abline(v = lm_alpha_other, col = "black", lty = 2)
lines(density(posterior_grow_mix_ant$`beta1[2]`),  col = "red")
abline(v = lm_alpha_crem, col = "red", lty = 2)
lines(density(posterior_grow_mix_ant$`beta1[3]`),col = "blue", lwd = 2)
abline(v = lm_alpha_liom, col = "blue", lty = 2)
lines(density(posterior_grow_mix_ant$`beta1[4]`), col = "pink", lwd = 2 )
abline(v = lm_alpha_vacant, col = "pink", lty = 2)
legend("topleft", legend = c("other","Crem.", "Liom.","Vac"), col = c("black","red","blue","pink"), lty = 1)
```

```{r}
bayesplot::mcmc_trace(As.mcmc.list(fit_grow_mix_ant, pars=c("beta0", "beta1")))
```

#### Survival
```{r Survival Ant Mixed Model}
vol = log(data$volume_t)
y = data$Survival_t1
N = nrow(data)
N_ant = 4
ant = data$ant
N_Year <- max(data$year)
N_Plot <- max(data$plot)
plot <- data$plot
year <- data$year
stan_data <- list(N = N, ## number of observations
                  vol = vol, ## predictors volume
                  y = y, ## response volume next year
                  ant = ant,## predictors ants
                  N_ant = N_ant, ## number of ant states
                  N_Year = N_Year, ## number of years
                  N_Plot = N_Plot, ## number of plots
                  plot = plot, ## predictor plots
                  year = year ## predictor years
) 

write("// Stan model for simple ant survival regression

data {
  int <lower = 1> N; // number of observations
  int <lower = 1> N_ant; // number of ant states
  int <lower = 1, upper = N_ant> ant[N]; // the list of ant species 
  vector[N] vol;	//size_t
  int <lower = 0, upper = 1> y[N]; // survival in year t1
  int<lower=1> N_Year; //number of plots
  int<lower=1> N_Plot; //number of years
  int<lower=1, upper=N_Plot> plot[N]; // plot
  int<lower=1, upper=N_Year> year[N]; // year
}
transformed data {
  real<lower = 0> mean_y = mean(to_vector(y));
  real<lower = 0> sd_y = sd(to_vector(y));
}
parameters {
  vector[N_ant] beta0; //intercept, unique to ant sp
  vector[N_ant] beta1; //slope, unique to ant sp
  vector[N_Plot] u; //subject intercepts
  vector[N_Year] w; //item intercepts
  real < lower = 0 > sigma; // Error SD
  real < lower = 0 > sigma_u; // plot SD
  real < lower = 0 > sigma_w; // year SD
}

transformed parameters{
  vector[N] mu; //linear predictor for the mean
  for(i in 1:N){
    mu[i] = beta0[ant[i]] + beta1[ant[i]] * vol[i] + u[plot[i]] + w[year[i]];
  }
}
model {
//Priors
 u ~ normal(0, sigma_u); // plot random effects
 w ~ normal(0, sigma_w); // year random effects
 beta0 ~ normal(0,100); // intercept distribution
 beta1 ~ normal(0,100); // slope distribution
 //Model
 for(i in 1:N){
 y[i] ~ bernoulli_logit(mu[i]);
 }
}
generated quantities {
  int<lower = 0> y_rep[N] = bernoulli_logit_rng(mu);
  real<lower = 0> mean_y_rep = mean(to_vector(y_rep));
  real<lower = 0> sd_y_rep = sd(to_vector(y_rep));
}
",

"surv_ant_mix_lm1.stan")
## Check that you wrote a file
#stanc("surv_ant_mix_lm1.stan")
## Save the file path
stanny <- "surv_ant_mix_lm1.stan"
## Now we fit the model
fit_surv_mix_ant <- stan(file = stanny, data = stan_data, warmup = 5, iter = 10, chains = 1, cores = 2, thin = 1)

#class(fit)
posterior_surv_mix_ant <- as.data.frame(fit_surv_mix_ant)
```

```{r Survival Visualize}
lm_alpha_other <- summary(surv_model_ant_interact)$coeff[1]  # the intercept
lm_alpha_crem <- summary(surv_model_ant_interact)$coeff[3]
lm_alpha_liom <- summary(surv_model_ant_interact)$coeff[4]
lm_alpha_vacant <- summary(surv_model_ant_interact)$coeff[5]
lm_beta_other <- summary(surv_model_ant_interact)$coeff[2]  # the slope
lm_beta_crem <- summary(surv_model_ant_interact)$coeff[6]
lm_beta_liom <- summary(surv_model_ant_interact)$coeff[7]
lm_beta_vacant <- summary(surv_model_ant_interact)$coeff[8]
lm_sigma <- sigma(surv_model_ant_interact)  # the residual error

par(mfrow = c(1,2))
#Plot Intercepts
plot(density(posterior_surv_mix_ant$`beta0[1]`), main = "Survival Intercept Distributions", col = "black", lwd = 2, xlim = c(-2,3), ylim =  c(0,7))
abline(v = lm_alpha_other, col = "black", lty = 2)
lines(density(posterior_surv_mix_ant$`beta0[2]`),  col = "red")
abline(v = lm_alpha_crem, col = "red", lty = 2)
lines(density(posterior_surv_mix_ant$`beta0[3]`),col = "blue", lwd = 2)
abline(v = lm_alpha_liom, col = "blue", lty = 2)
lines(density(posterior_surv_mix_ant$`beta0[4]`), col = "pink", lwd = 2)
abline(v = lm_alpha_vacant, col = "pink", lty = 2)
legend("topleft", legend = c("other","Crem.", "Liom.","Vac"), col = c("black","red","blue","pink"), lty = 1)
#Plot Slopes
plot(density(posterior_surv_mix_ant$`beta1[1]`), main = "Survival Slope Distributions", col = "black", lwd = 2, xlim = c(-1,3), ylim = c(0,1.4))
abline(v = lm_alpha_other, col = "black", lty = 2)
lines(density(posterior_surv_mix_ant$`beta1[2]`),  col = "red")
abline(v = lm_alpha_crem, col = "red", lty = 2)
lines(density(posterior_surv_mix_ant$`beta1[3]`),col = "blue", lwd = 2)
abline(v = lm_alpha_liom, col = "blue", lty = 2)
lines(density(posterior_surv_mix_ant$`beta1[4]`), col = "pink", lwd = 2 )
abline(v = lm_alpha_vacant, col = "pink", lty = 2)
legend("topleft", legend = c("other","Crem.", "Liom.","Vac"), col = c("black","red","blue","pink"), lty = 1)
```
The mean here is too large and the standard deviation is also too large

```{r}
bayesplot::mcmc_trace(As.mcmc.list(fit_surv_mix_ant, pars=c("beta0", "beta1")))
```


#### Total Flowers
```{r}
y <- flower$TotFlowerbuds_t
vol = flower$volume_t
N = nrow(flower)
N_ant = 4
ant = flower$ant
N_Year <- max(flower$year)
N_Plot <- max(flower$plot)
plot <- flower$plot
year <- flower$year
stan_data <- list(N = N, ## number of observations
                  vol = vol, ## predictors volume
                  y = y, ## response volume next year
                  ant = ant,## predictors ants
                  N_ant = N_ant, ## number of ant states
                  N_Year = N_Year, ## number of years
                  N_Plot = N_Plot, ## number of plots
                  plot = plot, ## predictor plots
                  year = year ## predictor years
) 

write("// Stan model for simple total flowers regression

data {
 int <lower = 1> N; // number of observations
  int <lower = 1> N_ant; // number of ant states
  int <lower = 1, upper = N_ant> ant[N]; // the list of ant species 
  vector[N] vol;	//size_t
  int <lower = 0> y[N]; // survival in year t1
  int<lower=1> N_Year; //number of plots
  int<lower=1> N_Plot; //number of years
  int<lower=1, upper=N_Plot> plot[N]; // plot
  int<lower=1, upper=N_Year> year[N]; // year
}
transformed data {
  real<lower = 0> mean_y = mean(to_vector(y));
  real<lower = 0> sd_y = sd(to_vector(y));
}
parameters {
  vector[N_ant] beta0; //intercept, unique to ant sp
  vector[N_ant] beta1; //slope, unique to ant sp
  vector[N_Plot] u; //subject intercepts
  vector[N_Year] w; //item intercepts
  real < lower = 0 > sigma; // Error SD
  real < lower = 0 > sigma_u; // plot SD
  real < lower = 0 > sigma_w; // year SD
}
transformed parameters{
  vector[N] mu; //linear predictor for the mean
  for(i in 1:N){
    mu[i] = beta0[ant[i]] + beta1[ant[i]] * vol[i] + u[plot[i]] + w[year[i]];
  }
}
model {
 // Model
  u ~ normal(0, sigma_u); // plot random effects
  w ~ normal(0, sigma_w); // year random effects
  beta0 ~ normal(0,100); // intercept distribution
  beta1 ~ normal(0,100); // slope distribution
  for(i in 1:N){
    y[i] ~ poisson(mu[i]);
  }
}
generated quantities {
  int<lower = 0> y_rep[N] = poisson_rng(mu);
  real<lower = 0> mean_y_rep = mean(to_vector(y_rep));
  real<lower = 0> sd_y_rep = sd(to_vector(y_rep));
} 
",

"flower_ant_mix_lm1.stan")
## Check that you wrote a file
#stanc("flower_ant_mix_lm1.stan")
## Save the file path
stanny <- "flower_ant_mix_lm1.stan"
## Now we fit the model
fit_flow_mix_ant <- stan(file = stanny, data = stan_data, warmup = 5, iter = 10, chains = 1, cores = 2, thin = 1)

posterior_flow_mix_ant <- as.data.frame(fit_flow_mix_ant)
```

```{r Ants Post Visualize}

par(mfrow = c(1,2))
#Plot Intercepts
plot(density(posterior_flow_mix_ant$`beta0[1]`), main = "Total Flowers Intercept Distributions", col = "black", lwd = 2, xlim = c(-2,4), ylim =  c(0,4.5))
abline(v = lm_alpha_other, col = "black", lty = 2)
lines(density(posterior_flow_mix_ant$`beta0[2]`),  col = "red")
abline(v = lm_alpha_crem, col = "red", lty = 2)
lines(density(posterior_flow_mix_ant$`beta0[3]`),col = "blue", lwd = 2)
abline(v = lm_alpha_liom, col = "blue", lty = 2)
lines(density(posterior_flow_mix_ant$`beta0[4]`), col = "pink", lwd = 2)
abline(v = lm_alpha_vacant, col = "pink", lty = 2)
legend("topright", legend = c("other","Crem.", "Liom.","Vac"), col = c("black","red","blue","pink"), lty = 1)
#Plot Slopes
plot(density(posterior_flow_mix_ant$`beta1[1]`), main = "Total Flowers Slope Distributions", col = "black", lwd = 2, xlim = c(-1,4.5), ylim = c(0,1.7))
abline(v = lm_alpha_other, col = "black", lty = 2)
lines(density(posterior_flow_mix_ant$`beta1[2]`),  col = "red")
abline(v = lm_alpha_crem, col = "red", lty = 2)
lines(density(posterior_flow_mix_ant$`beta1[3]`),col = "blue", lwd = 2)
abline(v = lm_alpha_liom, col = "blue", lty = 2)
lines(density(posterior_flow_mix_ant$`beta1[4]`), col = "pink", lwd = 2 )
abline(v = lm_alpha_vacant, col = "pink", lty = 2)
legend("topright", legend = c("other","Crem.", "Liom.","Vac"), col = c("black","red","blue","pink"), lty = 1)
```


```{r Total Visualize}
par(mfrow = c(1,2))
plot(density(posterior_flow_mix_ant$mean_y_rep), xlim = c(10.7, 73310))
abline(v = mean(flower$TotFlowerbuds_t), col = "red", lty = 2)
plot(density(posterior_flow_mix_ant$sd_y_rep), xlim = c(0,0.190))
abline(v = sd(flower$TotFlowerbuds_t), col = "red", lty = 2)

flow_mix_ant_mod <- stan_glmer(y ~ 0 + ant*vol + (1|year) + (1|plot),family = "poisson", warmup = 500, iter = 1000, chains = 1, cores = 2, thin = 1 )
plot_title <- ggtitle("Mixed Ant Effects Total Flowerbuds Model Simulated Data")
bayesplot::ppc_dens_overlay(y = flow_mix_ant_mod$y,
                 yrep = posterior_predict(flow_mix_ant_mod, draws = 50)) + plot_title

bayesplot::mcmc_trace(As.mcmc.list(fit_flow_mix_ant, pars=c("beta0", "beta1")))
```

#### Repro
```{r Repro Ant Mixed Model}
vol1 <- flower$volume_t1
y = flower$repro_state_t1
N = nrow(flower)
N_ant = 4
ant = flower$ant
N_Year <- max(flower$year)
N_Plot <- max(flower$plot)
plot <- flower$plot
year <- flower$year
stan_data <- list(N = N, ## number of observations
                  vol1 = vol1, ## predictors volume
                  y = y, ## response volume next year
                  ant = ant,## predictors ants
                  N_ant = N_ant, ## number of ant states
                  N_Year = N_Year, ## number of years
                  N_Plot = N_Plot, ## number of plots
                  plot = plot, ## predictor plots
                  year = year ## predictor years
) 


write("// Stan model for simple total flowers regression

data {
  int <lower = 1> N; // number of observations
  int <lower = 1> N_ant; // number of ant states
  int <lower = 1, upper = N_ant> ant[N]; // the list of ant species 
  vector[N] vol1;	//size_t
  int <lower = 0, upper = 1> y[N]; // survival in year t1
  int<lower=1> N_Year; //number of plots
  int<lower=1> N_Plot; //number of years
  int<lower=1, upper=N_Plot> plot[N]; // plot
  int<lower=1, upper=N_Year> year[N]; // year
}
transformed data {
  real<lower = 0> mean_y = mean(to_vector(y));
  real<lower = 0> sd_y = sd(to_vector(y));
}
parameters {
  vector[N_ant] beta0; //intercept, unique to ant sp
  vector[N_ant] beta1; //slope, unique to ant sp
  vector[N_Plot] u; //subject intercepts
  vector[N_Year] w; //item intercepts
  real < lower = 0 > sigma; // Error SD
  real < lower = 0 > sigma_u; // plot SD
  real < lower = 0 > sigma_w; // year SD
}
transformed parameters{
  vector[N] mu; //linear predictor for the mean
  for(i in 1:N){
    mu[i] = beta0[ant[i]] + beta1[ant[i]] * vol1[i] + u[plot[i]] + w[year[i]];
  }
}
model {
 // Priors
  u ~ normal(0, sigma_u); // plot random effects
  w ~ normal(0, sigma_w); // year random effects
  beta0 ~ normal(0,100); // intercept distribution
  beta1 ~ normal(0,100); // slope distribution
 // Model
 for(i in 1:N){
  y[i] ~ bernoulli_logit(mu[i]);
 }
}
generated quantities {
  int<lower = 0> y_rep[N] = bernoulli_logit_rng(mu);
  real<lower = 0> mean_y_rep = mean(to_vector(y_rep));
  real<lower = 0> sd_y_rep = sd(to_vector(y_rep));
}
",

"repro_ant_mix_lm1.stan")

## Check that you wrote a file
#stanc("repro_ant_mix_lm1.stan")
## Save the file path
stanny <- "repro_ant_mix_lm1.stan"
## Now we fit the model
fit_repro_mix_ant <- stan(file = stanny, data = stan_data, warmup = 5, iter = 10, chains = 1, cores = 2, thin = 1)

posterior_repro_mix_ant <- as.data.frame(fit_repro_mix_ant)
```

```{r Ants Post Visualize}

par(mfrow = c(1,2))
#Plot Intercepts
plot(density(posterior_repro_mix_ant$`beta0[1]`), main = "Reproductive State Intercept Distributions", col = "black", lwd = 2, xlim = c(-6,4), ylim =  c(0,25))
abline(v = lm_alpha_other, col = "black", lty = 2)
lines(density(posterior_repro_mix_ant$`beta0[2]`),  col = "red", lwd = 2)
abline(v = lm_alpha_crem, col = "red", lty = 2)
lines(density(posterior_repro_mix_ant$`beta0[3]`),col = "blue", lwd = 2)
abline(v = lm_alpha_liom, col = "blue", lty = 2)
lines(density(posterior_repro_mix_ant$`beta0[4]`), col = "pink", lwd = 2)
abline(v = lm_alpha_vacant, col = "pink", lty = 2)
legend("topleft", legend = c("other","Crem.", "Liom.","Vac"), col = c("black","red","blue","pink"), lty = 1)
#Plot Slopes
plot(density(posterior_repro_mix_ant$`beta1[1]`), main = "Reproductive State Slope Distributions", col = "black", lwd = 2, xlim = c(-6,4.5), ylim = c(0,25 ))
abline(v = lm_alpha_other, col = "black", lty = 2)
lines(density(posterior_repro_mix_ant$`beta1[2]`),  col = "red", lwd = 2)
abline(v = lm_alpha_crem, col = "red", lty = 2)
lines(density(posterior_repro_mix_ant$`beta1[3]`),col = "blue", lwd = 2)
abline(v = lm_alpha_liom, col = "blue", lty = 2)
lines(density(posterior_repro_mix_ant$`beta1[4]`), col = "pink", lwd = 2 )
abline(v = lm_alpha_vacant, col = "pink", lty = 2)
legend("topleft", legend = c("other","Crem.", "Liom.","Vac"), col = c("black","red","blue","pink"), lty = 1)
```

```{r Reproduction Visualize}
par(mfrow = c(1,2))
plot(density(posterior_repro_mix_ant$mean_y_rep), xlim = c(10.7, 73310))
abline(v = mean(flower$repro_state_t1), col = "red", lty = 2)
plot(density(posterior_repro_mix_ant$sd_y_rep), xlim = c(0,0.190))
abline(v = sd(flower$repro_state_t1), col = "red", lty = 2)

repro_mix_ant_mod <- stan_glmer(y ~ 0 + ant*vol + (1|year) + (1|plot),family = "binomial", warmup = 500, iter = 1000, chains = 1, cores = 2, thin = 1 )
plot_title <- ggtitle("Mixed Ant Effects Reproductive State Model Simulated Data")
bayesplot::ppc_dens_overlay(y = repro_mix_ant_mod$y,
                 yrep = posterior_predict(repro_mix_ant_mod, draws = 50)) + plot_title

bayesplot::mcmc_trace(As.mcmc.list(fit_repro_mix_ant, pars=c("beta0", "beta1")))
```


####Viability Model

```{r Viability model}
good <- flower$Goodbuds_t
abort <- flower$ABFlowerbuds_t
tot <- flower$TotFlowerbuds_t
vol = log(flower$volume_t)
N = nrow(flower)
N_ant = 4
ant = flower$ant
N_Year <- max(flower$year)
N_Plot <- max(flower$plot)
plot <- flower$plot
year <- flower$year
stan_data <- list(N = N, ## number of observations = trials
                  N_ant = N_ant,
                  ant = ant,
                  good = good, ## good buds = successes
                  abort = abort, ## aborted buds data
                  tot = tot, ## number of trials
                  vol = vol,
                  N_Year = N_Year, ## number of years
                  N_Plot = N_Plot, ## number of plots
                  plot = plot, ## predictor plots
                  year = year ## predictor years
) 

write("// Stan model for simple total flowers regression
data {
 int < lower = 1 > N; // Sample size
 int <lower = 0> good[N]; // Number of viable seeds
 int <lower = 1> N_ant; // number of ant states
 int <lower = 1, upper = N_ant> ant[N]; // the list of ant species 
 int<lower=0> tot[N]; // number of trials
 int<lower=0> abort[N];
 vector[N] vol;	//size_t
 int<lower=1> N_Year; //number of plots
  int<lower=1> N_Plot; //number of years
  int<lower=1, upper=N_Plot> plot[N]; // plot
  int<lower=1, upper=N_Year> year[N]; // year
}
transformed data {
  real<lower = 0> mean_y = mean(to_vector(good));
  real<lower = 0> sd_y = sd(to_vector(good));
}
parameters {
  real theta[N]; // probability of viability for each bud
  //
  real<lower=0,upper=1> v0;
  vector[N_Plot] u; //subject intercepts
  vector[N_Year] w; //item intercepts
  real < lower = 0 > sigma; // Error SD
  real < lower = 0 > sigma_u; // plot SD
  real < lower = 0 > sigma_w; // year SD
}
transformed parameters{
  real<lower=0,upper=1> predV[N]; // proportion viable for each plant?
  // Prediction for seed viability
  for(i in 1:N){
    logit(predV[i]) = theta[ant[i]] + u[ant[i]] + w[ant[i]];
  }
}
model {
 // Priors
  v0  ~ beta(10,1);  // intercept viability model
  theta ~ normal(0,100); // intercept distribution
  //Model Statements
  u ~ normal(0, sigma_u); // plot random effects
  w ~ normal(0, sigma_w); // year random effects
  
  good ~ binomial(tot, predV);
}
generated quantities {
  int<lower = 0> y_rep[N] = binomial_rng(tot,predV);
  real<lower = 0> mean_y_rep = mean(to_vector(y_rep));
  real<lower = 0> sd_y_rep = sd(to_vector(y_rep));
}
", "viab_mix_ant.stan")
## Check that you wrote a file
stanc("viab_mix_ant.stan")
## Save the file path
stanny <- "viab_mix_ant.stan"
## Now we fit the model
fit_viab_mix_ant <- stan(file = stanny, data = stan_data, warmup = 5, iter = 10, chains = 1, cores = 2, thin = 1)


posterior_viab_mix_ant <- as.data.frame(fit_viab_mix_ant)
```

```{r Visualize}
par(mfrow = c(1,2))
plot(density(posterior_viab_mix_ant$mean_y_rep), xlim = c(2.19,10))
abline(v = mean(flower$Goodbuds_t), col = "red", lty = 2)
plot(density(posterior_viab_mix_ant$sd_y_rep), xlim = c(3.3,8.7))
abline(v = sd(flower$Goodbuds_t), col = "red", lty = 2)

viab_mix_ant_mod <- stan_glmer(cbind(flower$Goodbuds_t,flower$ABFlowerbuds_t) ~ flower$ant + (1|flower$year) + (1|flower$plot),family = "binomial", warmup = 5, iter = 10, chains = 1, cores = 2, thin = 1 )
plot_title <- ggtitle("Mixed Ant Effects Viability Model Simulated Data")
bayesplot::ppc_dens_overlay(y = viab_mix_ant_mod$y,
                 yrep = posterior_predict(viab_mix_ant_mod, draws = 5)) + plot_title
fit_viab_mix_ant$v
bayesplot::mcmc_trace(As.mcmc.list(fit_viab_mix_ant, pars=c("v0")))
```

```{r Visualize}
lm_alpha_other <- summary(viab_model_ant_interact)$coeff[1]  # the intercept
lm_alpha_crem <- summary(viab_model_ant_interact)$coeff[3]
lm_alpha_liom <- summary(viab_model_ant_interact)$coeff[4]
lm_alpha_vacant <- summary(viab_model_ant_interact)$coeff[5]
lm_beta_other <- summary(viab_model_ant_interact)$coeff[2]  # the slope
lm_beta_crem <- summary(viab_model_ant_interact)$coeff[6]
lm_beta_liom <- summary(viab_model_ant_interact)$coeff[7]
lm_beta_vacant <- summary(viab_model_ant_interact)$coeff[8]

#Plot Slopes
plot(density(posterior_viab_ant$`theta[1]`), main = "Viability Slope Distributions", col = "black", lwd = 2, xlim = c(-1,2), ylim =  c(0,4))
abline(v = lm_alpha_other, col = "black", lty = 2)
lines(density(posterior_viab_ant$`theta[2]`),  col = "red")
abline(v = lm_alpha_crem, col = "red", lty = 2)
lines(density(posterior_viab_ant$`theta[3]`),col = "blue", lwd = 2)
abline(v = lm_alpha_liom, col = "blue", lty = 2)
lines(density(posterior_viab_ant$`theta[4]`), col = "pink", lwd = 2)
abline(v = lm_alpha_vacant, col = "pink", lty = 2)
legend("topleft", legend = c("other","Crem.", "Liom.","Vac"), col = c("black","red","blue","pink"), lty = 1)
```

## Multinomial
#### 1
```{r}
N <- nrow(data)
vol = log(data$volume_t)
ant <- data$ant
N_ant <- length(unique(data$ant))
y <- data$ant1
N_Year <- max(data$year)
N_Plot <- max(data$plot)
plot <- data$plot
year <- data$year
stan_data <- list(N = N, ## number of observations
                  N_ant = N_ant, ## number of ants
                  K = K, ## number of covariates (only volume I think)
                  vol = vol, ## Volume in year t
                  y = y, ## ant state in year t1
                  N_Year = N_Year,
                  N_Plot = N_Plot,
                  year = year,
                  plot = plot,
                  ant = ant ## ant state in year t
)
write("
data {
    int<lower=2> N_ant; // of alternatives/outcomes
    int<lower=1> N; // of observations
    int <lower=0,upper=N_ant> y[N];
    int <lower = 1, upper = N_ant> ant[N]; // the list of ant species 
    vector[N] vol;
    int<lower=1> N_Year; //number of plots
    int<lower=1> N_Plot; //number of years
    int<lower=1, upper=N_Plot> plot[N]; // plot
    int<lower=1, upper=N_Year> year[N]; // year
}

parameters {
  vector[N_ant] beta0; //intercept, unique to ant sp
  vector[N_Plot] u; //subject intercepts
  vector[N_Year] w; //item intercepts
  real < lower = 0 > sigma_u; // plot SD
  real < lower = 0 > sigma_w; // year SD

}
transformed parameters{
  vector[N] mu; //linear predictor for the mean
  for(i in 1:N){
    mu[i] = beta0[ant[i]]  + u[plot[i]] + w[year[i]];
  }
}
model {
  // Model
  u ~ normal(0, sigma_u); // plot random effects
  w ~ normal(0, sigma_w); // year random effects
  beta0 ~ normal(0,100); // intercept distribution
    y ~ categorical_logit(mu);
}
generated quantities {
  int<lower = 0> y_rep[N] = multinomial_rng(mu);
}
",
"multinomial1.stan")
#stanc("multinomial1.stan")
## Save the file path
stanny <- "multinomial1.stan"
## Now we fit the model
fit_multi1 <- stan(file = stanny, data = stan_data, warmup = 5, iter = 10, chains = 4, cores = 2, thin = 1)
#class(fit)
posterior_multi1 <- as.data.frame(fit_multi1)
```

```{r 1 Visualize}
par(mfrow = c(1,2))
plot(density(posterior_multi1$mean_y_rep), xlim = c(10.7, 73310))
abline(v = mean(data$ant1), col = "red", lty = 2)
plot(density(posterior_multi1$sd_y_rep), xlim = c(0,0.190))
abline(v = sd(data$ant1), col = "red", lty = 2)

multi1_mod <- stan_glmer(y ~ 0 + ant + (1|year) + (1|plot), warmup = 5, iter = 10, chains = 1, cores = 2, thin = 1 )
plot_title <- ggtitle("Mixed Ant T1 State Model Simulated Data")
bayesplot::ppc_dens_overlay(y = multi1_mod$y,
                 yrep = posterior_predict(multi1_mod, draws = 5)) + plot_title

bayesplot::mcmc_trace(As.mcmc.list(fit_multi1, pars=c("beta0")))
```

```{r 1}
traceplot(fit_multi1, pars = c("beta0", "sigma"))

plot(posterior_multi1$`beta0[1]`, type = "l", col = "black", lwd = 2, ylim = c(-0.8,1.5))
lines(posterior_multi1$`beta0[2]`, type = "l", col = "red", lwd = 2)
lines(posterior_multi1$`beta0[3]`, type = "l", col = "blue", lwd = 2)
lines(posterior_multi1$`beta0[4]`, type = "l", col = "pink", lwd = 2)
```


#### 2 Ants no interaction
```{r}
N <- nrow(data)
vol = log(data$volume_t)
ant <- data$ant
N_ant <- length(unique(data$ant))
y <- data$ant1
N_Year <- max(data$year)
N_Plot <- max(data$plot)
plot <- data$plot
year <- data$year
stan_data <- list(N = N, ## number of observations
                  N_ant = N_ant, ## number of ants
                  K = K, ## number of covariates (only volume I think)
                  vol = vol, ## Volume in year t
                  y = y, ## ant state in year t1
                  N_Year = N_Year,
                  N_Plot = N_Plot,
                  year = year,
                  plot = plot,
                  ant = ant ## ant state in year t
)
write("
data {
    int<lower=2> N_ant; // of alternatives/outcomes
    int<lower=1> N; // of observations
    int <lower=0,upper=N_ant> y[N];
    int <lower = 1, upper = N_ant> ant[N]; // the list of ant species 
    vector[N] vol;
    int<lower=1> N_Year; //number of plots
    int<lower=1> N_Plot; //number of years
    int<lower=1, upper=N_Plot> plot[N]; // plot
    int<lower=1, upper=N_Year> year[N]; // year
}
transformed data {
  real<lower = 0> mean_y = mean(to_vector(y));
  real<lower = 0> sd_y = sd(to_vector(y));
}
parameters {
  vector[N_ant] beta0; //intercept, unique to ant sp
  real beta1; //slope, unique to ant sp
  vector[N_Plot] u; //subject intercepts
  vector[N_Year] w; //item intercepts
  real < lower = 0 > sigma; // Error SD
  real < lower = 0 > sigma_u; // plot SD
  real < lower = 0 > sigma_w; // year SD

}
transformed parameters{
  vector[N] mu; //linear predictor for the mean
  for(i in 1:N){
    mu[i] = beta0[ant[i]] + beta1 * vol[i] + u[plot[i]] + w[year[i]];
  }
}
model {
  // Model
  u ~ normal(0, sigma_u); // plot random effects
  w ~ normal(0, sigma_w); // year random effects
  beta0 ~ normal(0,100); // intercept distribution
  beta1 ~ normal(0,100); // slope distribution
    y ~ categorical_logit(mu);
}
generated quantities {
  int<lower = 0> y_rep[N] = multinomial_rng(mu);
  real<lower = 0> mean_y_rep = mean(to_vector(y_rep));
  real<lower = 0> sd_y_rep = sd(to_vector(y_rep));
}
",
"multinomial2.stan")
stanc("multinomial2.stan")
## Save the file path
stanny <- "multinomial2.stan"
## Now we fit the model
fit_multi2 <- stan(file = stanny, data = stan_data, warmup = 5, iter = 10, chains = 1, cores = 2, thin = 1)
#class(fit)
posterior_multi2 <- as.data.frame(fit_multi2)
```

```{r 2 Visualize}
par(mfrow = c(1,2))
plot(density(posterior_multi2$mean_y_rep), xlim = c(10.7, 73310))
abline(v = mean(data$ant1), col = "red", lty = 2)
plot(density(posterior_multi2$sd_y_rep), xlim = c(0,0.190))
abline(v = sd(data$ant1), col = "red", lty = 2)

multi2_mod <- stan_glmer(y ~ 0 + ant + vol + (1|year) + (1|plot), warmup = 5, iter = 10, chains = 1, cores = 2, thin = 1 )
plot_title <- ggtitle("Mixed Ant Effects Ant T1 State Model Simulated Data")
bayesplot::ppc_dens_overlay(y = multi2_mod$y,
                 yrep = posterior_predict(multi2_mod, draws = 5)) + plot_title

bayesplot::mcmc_trace(As.mcmc.list(fit_multi2, pars=c("beta0", "beta1")))
```

```{r}
traceplot(fit_multi2, pars = c("beta0", "beta1", "sigma"))

par(mfrow = c(1,2))
plot(posterior_multi2$`beta0[1]`, type = "l", col = "black", lwd = 2, ylim = c(-2.2, 0))
lines(posterior_multi2$`beta0[2]`, type = "l", col = "red", lwd = 2)
lines(posterior_multi2$`beta0[3]`, type = "l", col = "blue", lwd = 2)
lines(posterior_multi2$`beta0[4]`, type = "l", col = "pink", lwd = 2)
plot(posterior_multi2$`beta1`, type = "l", col = "black", lwd = 2, lty = 2)
```


#### 3

```{r}
N <- nrow(data)
vol = log(data$volume_t)
ant <- data$ant
N_ant <- length(unique(data$ant))
y <- data$ant1
N_Year <- max(data$year)
N_Plot <- max(data$plot)
plot <- data$plot
year <- data$year
stan_data <- list(N = N, ## number of observations
                  N_ant = N_ant, ## number of ants
                  K = K, ## number of covariates (only volume I think)
                  vol = vol, ## Volume in year t
                  y = y, ## ant state in year t1
                  N_Year = N_Year,
                  N_Plot = N_Plot,
                  year = year,
                  plot = plot,
                  ant = ant ## ant state in year t
)
write("
data {
    int<lower=2> N_ant; // of alternatives/outcomes
    int<lower=1> N; // of observations
    int <lower=0,upper=N_ant> y[N];
    int <lower = 1, upper = N_ant> ant[N]; // the list of ant species 
    vector[N] vol;
    int<lower=1> N_Year; //number of plots
    int<lower=1> N_Plot; //number of years
    int<lower=1, upper=N_Plot> plot[N]; // plot
    int<lower=1, upper=N_Year> year[N]; // year
}
transformed data {
  real<lower = 0> mean_y = mean(to_vector(y));
  real<lower = 0> sd_y = sd(to_vector(y));
}
parameters {
  vector[N_ant] beta0; //intercept, unique to ant sp
  vector[N_ant] beta1; //slope, unique to ant sp
  vector[N_Plot] u; //subject intercepts
  vector[N_Year] w; //item intercepts
  real < lower = 0 > sigma; // Error SD
  real < lower = 0 > sigma_u; // plot SD
  real < lower = 0 > sigma_w; // year SD

}
transformed parameters{
  vector[N] mu; //linear predictor for the mean
  for(i in 1:N){
    mu[i] = beta0[ant[i]] + beta1[ant[i]] * vol[i] + u[plot[i]] + w[year[i]];
  }
}
model {
  // Model
  u ~ normal(0, sigma_u); // plot random effects
  w ~ normal(0, sigma_w); // year random effects
  beta0 ~ normal(0,100); // intercept distribution
  beta1 ~ normal(0,100); // slope distribution
    y ~ categorical_logit(mu);
}
generated quantities {
  int<lower = 0> y_rep[N] = multinomial_rng(mu);
  real<lower = 0> mean_y_rep = mean(to_vector(y_rep));
  real<lower = 0> sd_y_rep = sd(to_vector(y_rep));
}
",
"multinomial3.stan")
#stanc("multinomial3.stan")
## Save the file path
stanny <- "multinomial3.stan"
## Now we fit the model
fit_multi3 <- stan(file = stanny, data = stan_data, warmup = 5, iter = 10, chains = 1, cores = 2, thin = 1)
#class(fit)
posterior_multi3 <- as.data.frame(fit_multi3)
```

```{r 3 Visualize}
par(mfrow = c(1,2))
plot(density(posterior_multi3$mean_y_rep), xlim = c(10.7, 73310))
abline(v = mean(data$ant1), col = "red", lty = 2)
plot(density(posterior_multi3$sd_y_rep), xlim = c(0,0.190))
abline(v = sd(data$ant1), col = "red", lty = 2)

multi3_mod <- stan_glmer(y ~ 0 + ant*vol + (1|year) + (1|plot), warmup = 5, iter = 10, chains = 1, cores = 2, thin = 1 )
plot_title <- ggtitle("Mixed Ant Interaction Effects Ant T1 State Model Simulated Data")
bayesplot::ppc_dens_overlay(y = multi3_mod$y,
                 yrep = posterior_predict(multi3_mod, draws = 5)) + plot_title

bayesplot::mcmc_trace(As.mcmc.list(fit_multi3, pars=c("beta0", "beta1")))
```

```{r}
par(mfrow = c(1,2))
plot(posterior_multi3$`beta0[1]`, type = "l", col = "black", lwd = 2, ylim = c(-2,1))
lines(posterior_multi3$`beta0[2]`, type = "l", col = "red", lwd = 2)
lines(posterior_multi3$`beta0[3]`, type = "l", col = "blue", lwd = 2)
lines(posterior_multi3$`beta0[4]`, type = "l", col = "pink", lwd = 2)
plot(posterior_multi3$`beta1[1]`, type = "l", col = "black", lwd = 2, lty = 2, ylim = c(-1.5,1))
lines(posterior_multi3$`beta1[2]`, type = "l", col = "red", lwd = 2, lty = 2)
lines(posterior_multi3$`beta1[3]`, type = "l", col = "blue", lwd = 2, lty = 2)
lines(posterior_multi3$`beta1[4]`, type = "l", col = "pink", lwd = 2, lty = 2)


```

